# Main application file that brings together all modules.

from fastapi import FastAPI, Query
from fastapi.responses import HTMLResponse, RedirectResponse
from fastapi.middleware.cors import CORSMiddleware

from config import API_TITLE, API_VERSION, APP_URL
from database import init_database

# Import routers
from routes import auth, accounts, admin

# Create FastAPI app
app = FastAPI(title=API_TITLE, version=API_VERSION)

# CORS middleware to allow iOS app to connect
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include routers
app.include_router(auth.router)
app.include_router(accounts.router)
app.include_router(admin.router)

@app.get("/")
async def root():
    return {
        "message": "Welcome to Luca App API",
        "version": API_VERSION,
        "status": "running",
        "security": "enabled",
    }

@app.get("/health")
def health_check():    
    return {"status": "healthy"}

@app.get("/reset", response_class=HTMLResponse)
async def reset_password_redirect(token: str = Query(..., description="Password reset token")):
    """
    Redirect endpoint for password reset emails.
    
    When users click the reset link in their email, they hit this endpoint.
    This page attempts to open the app via deep link, or provides a fallback.
    """
    deep_link = f"lucaapp://reset-password?token={token}"
    
    html_content = f'''
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Luca App</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }}
        .container {{
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }}
        h1 {{
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }}
        p {{
            color: #666;
            line-height: 1.6;
            margin-bottom: 30px;
        }}
        .button {{
            display: inline-block;
            background-color: #D9B53E;
            color: white;
            padding: 14px 32px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            transition: background-color 0.3s;
        }}
        .button:hover {{
            background-color: #c5a136;
        }}
        .info {{
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #eee;
            font-size: 14px;
            color: #888;
        }}
        .spinner {{
            border: 3px solid #f3f3f3;
            border-top: 3px solid #D9B53E;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }}
        @keyframes spin {{
            0% {{ transform: rotate(0deg); }}
            100% {{ transform: rotate(360deg); }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Reset Your Password</h1>
        <div class="spinner"></div>
        <p>Redirecting you to the Luca App...</p>
        <p>If the app doesn't open automatically, click the button below:</p>
        <a href="{deep_link}" class="button">Open Luca App</a>
        <div class="info">
            <p>Don't have the app installed?<br>
            Download it from the App Store to continue.</p>
        </div>
    </div>
    
    <script>
        // Attempt to open the app automatically
        window.location.href = "{deep_link}";
        
        // Fallback: If the app doesn't open after 2 seconds, user can click the button
        setTimeout(function() {{
            document.querySelector('.spinner').style.display = 'none';
        }}, 2000);
    </script>
</body>
</html>
    '''
    
    return HTMLResponse(content=html_content)

@app.on_event("startup")
async def startup_event():
    """Initialize database on startup"""
    init_database()
    print("üöÄ Luca App API started successfully")
    print("üìù API docs available at: http://localhost:6769/docs")
    print("üìã Registration fields: name, email, phone, date_of_birth, password")
    print(f"üîó App URL for emails: {APP_URL}")

if __name__ == "__main__":
    import uvicorn
    import os
    port = int(os.environ.get("PORT", 6769))
    uvicorn.run(app, host="0.0.0.0", port=port)